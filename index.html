<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Dinossaur Cladogram</title>
	<style type="text/css">
		body {
			margin: 0px;
			overflow: hidden;
			background: #1e1e2f;
		}
	</style>
</head>
<body>
	<canvas id='screen'></canvas>
	<script type="text/javascript">
		const canvas = document.getElementById('screen')
		const ctx = canvas.getContext('2d')
		const TAU = Math.PI*2

		canvas.width = window.innerWidth
		canvas.height = window.innerHeight

		ctx.font = "32px Arial"
		ctx.textBaseline = 'middle'

		const cladogram = {
			name: 'Dinosaurs',
			children: [
				{ name: 'Sauropodomorpha', children: [
					{ name: 'Prosauropoda', children: [] },
					{ name: 'Sauropoda', children: [
						{ name: 'Macronaria', children: [
							{ name: 'Brachiosauridae', children: [] },
							{ name: 'Titanosauria', children: [] },
						] },
						{ name: 'Diplodocoidea', children: [] },
					] },
				] },
				{ name: 'Ornithoceslida', children: [
					{ name: 'Theropoda', children: [
						{ name: 'Coelophysoidea', children: [] },
						{ name: 'Dilophosauridae', children: [] },
						{ name: 'Ceratosauria', children: [
							{ name: 'Abelisauroidea', children: [] },
							{ name: 'Ceratosauridae', children: [] },
						] },
						{ name: 'Tetanurae', children: [
							{ name: 'Megalosauroidea', children: [
								{ name: 'Megalosauridae', children: [] },
								{ name: 'Spinosauridae', children: [] },
							] },
							{ name: 'Carnosauria', children: [
								{ name: 'Allosauroidea', children: [] },
								{ name: 'Carcharodontosauria', children: [] },
							] },
							{ name: 'Coelurosauria', children: [
								{ name: 'Compsognathidae', children: [] },
								{ name: 'Tyrannosauridae', children: [] },
								{ name: 'Ornithomimosauria', children: [] },
								{ name: 'Maniraptora', children: [
									{ name: 'Therizinosauria', children: [] },
									{ name: 'Oviraptorosauria', children: [] },
									{ name: 'Archaeopterygidae', children: [] },
									{ name: 'Dromaeosauridae', children: [] },
									{ name: 'Troodontidae', children: [] },
									{ name: 'Avialae', children: [] },
								] },
							] },
						] },
						
					] },
					{ name: 'Ornithischia', children: [
						{ name: 'Heterodontosauridae', children: [] },
						{ name: 'Genasauria', children: [
							{ name: 'Thyreophora', children: [
								{ name: 'Ankylosauria', children: [] },
								{ name: 'Stegosauria', children: [] },
							] },
							{ name: 'Neornithischia', children: [
								{ name: 'Cerapoda', children: [
									{ name: 'Ornithopoda', children: [] },
									{ name: 'Marginocephalia', children: [
										{ name: 'Ceratopsia', children: [] },
										{ name: 'Pachycephalosauria', children: [] },
									] },
								] },
								{ name: 'Groups I can\'t recognize anyone', children: [] },
							] },
						] },
					] },
				] },
			]
		}


		let origin = {
			x: canvas.width/2,
			y: canvas.height/2,
		}

		let polar_coord = { mag: Infinity, angle: 0 }
		let cart_coord = { x: 0, y: 0 }

		let mouse_clicking = false

		let root_node = cladogram
		let path = []

		let next_root_node = null

		function hash_name(string) {
			return string.split('').reduce((acc, char) => acc ^ ((acc<<5)-acc) + char.charCodeAt(0), 0) % 36 * 10
		}

		function polar_to_cart(mag, angle) {
			return [
				Math.cos(angle) * mag + origin.x,
				Math.sin(angle) * mag + origin.y
			]
		}

		function ease(x) {
			return 1 - (1 - x) * (1 - x)
		}

		function draw_section(arc_start, arc_size, iradius, oradius) {
			const start_angle = arc_start
			const end_angle = arc_start + arc_size
			ctx.beginPath()
			ctx.arc(origin.x, origin.y, iradius, end_angle - (Math.PI/2), start_angle - (Math.PI/2), true)
			ctx.arc(origin.x, origin.y, oradius, start_angle - (Math.PI/2), end_angle - (Math.PI/2))
			ctx.fill()
		}

		function draw_node_children(root, iradius, size, arc_size, arc_start, depth, init_depth, anim_radius, parents) {
			if (depth == 0) return
			if (iradius > anim_radius) return

			const count = root.children.length
			const ARC = arc_size/count
			let opacity = (depth)/init_depth

			for (let index = 0; index < count; ++index) {
				
				const node = root.children[index]
				
				const arc_s = index*ARC+arc_start
				const arc_e = index*ARC+arc_start + ARC

				const size_high =
					!start_animation_radius.going &&
					polar_coord.mag > iradius && 
					polar_coord.mag < iradius + size &&
					polar_coord.angle > arc_s &&
					polar_coord.angle < arc_e
						? 2 
						: 0

				const local_opacity = size_high > 0 ? 1 : opacity

				if (size_high && mouse_clicking) {
					next_root_node = node
					
					path = path.concat(parents)

					mouse_clicking = false
					start_animation_radius.going = true
					start_animation_radius.time = 0
					start_animation_radius.back = true
				}
				
				const oradius = Math.max(iradius + 5, Math.min(iradius + size + size_high, anim_radius))
				
				ctx.fillStyle = `hsla(${hash_name(node.name)}, 50%, 60%, ${local_opacity*100}%)`

				draw_section(arc_s, ARC, iradius + 5 - size_high, oradius)

				if (node.children.length > 0) {
					draw_node_children(node, iradius+size, size, ARC, arc_s, depth - 1, init_depth, anim_radius, [...parents, node])
				}

				ctx.font = `${32*opacity}px Arial`

				if (size_high || depth == 1 || node.children.length == 0) {
					const coord = polar_to_cart(oradius+10, arc_s+ARC/2 - Math.PI/2)
					ctx.textAlign = coord[0] < origin.x ? 'end' : 'start'
					ctx.fillStyle = `rgb(224, 224, 224)`
					ctx.fillText(node.name, ...coord)
				}
			}
		}

		let start_animation_radius = {
			going: false,
			time: 0,
			start: undefined,
			duration: 500,
			back: false
		}

		function show_idle(timestamp) {
			const root = root_node

			ctx.clearRect(0, 0, canvas.width, canvas.height)

			if (start_animation_radius.going) {
				if (start_animation_radius.start == undefined)
					start_animation_radius.start = timestamp

				start_animation_radius.time = timestamp - start_animation_radius.start

				if (start_animation_radius.time >= start_animation_radius.duration) {
					start_animation_radius.going = false
					start_animation_radius.time = start_animation_radius.duration
					start_animation_radius.start = undefined
				}
			}

			const anim_radius = start_animation_radius.back 
				? (1 - ease(start_animation_radius.time/start_animation_radius.duration)) * 250
				: ease(start_animation_radius.time/start_animation_radius.duration) * 250

			ctx.font = `24px Arial`
			ctx.textAlign = 'start'
			let path_y = 0
			for (const node of path) {
				const hover =
					cart_coord.y > 10 + path_y*24 &&
					cart_coord.y < 34 + path_y*24

				if (hover && mouse_clicking) {
					next_root_node = node
					path = path.slice(0, path_y)
					mouse_clicking = false
					start_animation_radius.going = true
					start_animation_radius.time = 0
					start_animation_radius.back = true
				}

				ctx.fillStyle = `hsl(${hash_name(node.name)}, 50%, 60%)`
				ctx.fillText(node.name, hover ? 30 : 20, 20 + path_y*24)
				path_y += 1
			}

			ctx.fillStyle = `hsl(${hash_name(root.name)}, 50%, 60%)`
			ctx.beginPath()
			ctx.arc(origin.x, origin.y, Math.min(100, anim_radius), 0, TAU)
			ctx.fill()

			ctx.font = `${(anim_radius/200)*24}px Arial`
			ctx.textAlign = 'center'
			ctx.fillStyle = `#e0e0e0`
			ctx.fillText(root.name, origin.x, origin.y)

			if (100 <= anim_radius) {
				draw_node_children(root, 100, 50, TAU, 0, 3, 3, anim_radius, [root])
			}

			if (next_root_node && start_animation_radius.going == false) {
				root_node = next_root_node
				next_root_node = null
				start_animation_radius.going = true
				start_animation_radius.time = 0
				start_animation_radius.back = false
			}

			window.requestAnimationFrame(show_idle)
		}

		document.addEventListener('mousemove', (e) => {
			// console.log(e)
			const dist = Math.hypot(e.clientX - origin.x, e.clientY - origin.y)
			const angle = Math.atan2(e.clientY - origin.y, e.clientX - origin.x)
			const norm = (angle > 0 ? angle : angle + 2 * Math.PI) - 3*Math.PI/2

			polar_coord.mag = dist
			polar_coord.angle = (norm > 0 ? norm : norm + 4*Math.PI/2)

			cart_coord.x = e.clientX
			cart_coord.y = e.clientY
		})

		document.addEventListener('mousedown', (e) => { if (e.button == 0) mouse_clicking = true; })
		document.addEventListener('mouseup', (e) => { if (e.button == 0) mouse_clicking = false; })

		start_animation_radius.going = true
		window.requestAnimationFrame(show_idle)
	</script>
</body>
</html>