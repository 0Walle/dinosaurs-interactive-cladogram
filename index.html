<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Dinossaur Cladogram</title>
	<style type="text/css">
		body {
			margin: 0px;
			overflow: hidden;
			background: #1e1e2f;
		}
	</style>
</head>
<body oncontextmenu="return false;">
	<canvas id='screen'></canvas>
	<script type="text/javascript">
		const canvas = document.getElementById('screen')
		const ctx = canvas.getContext('2d')
		const TAU = Math.PI*2

		canvas.width = window.innerWidth
		canvas.height = window.innerHeight

		ctx.font = "32px Arial"
		ctx.textBaseline = 'middle'

		const cladogram = {
			name: 'Dinosaurs',
			children: [
				{ name: 'Sauropodomorpha', children: [
					{ name: 'Prosauropoda', children: [] },
					{ name: 'Sauropoda', children: [
						{ name: 'Macronaria', children: [
							{ name: 'Brachiosauridae', children: [] },
							{ name: 'Titanosauria', children: [] },
						] },
						{ name: 'Diplodocoidea', children: [] },
					] },
				] },
				{ name: 'Ornithoceslida', children: [
					{ name: 'Theropoda', children: [
						{ name: 'Coelophysoidea', children: [] },
						{ name: 'Dilophosauridae', children: [] },
						{ name: 'Ceratosauria', children: [
							{ name: 'Abelisauroidea', children: [] },
							{ name: 'Ceratosauridae', children: [] },
						] },
						{ name: 'Tetanurae', children: [
							{ name: 'Megalosauroidea', children: [
								{ name: 'Megalosauridae', children: [] },
								{ name: 'Spinosauridae', children: [] },
							] },
							{ name: 'Carnosauria', children: [
								{ name: 'Allosauroidea', children: [] },
								{ name: 'Carcharodontosauria', children: [] },
							] },
							{ name: 'Coelurosauria', children: [
								{ name: 'Compsognathidae', children: [] },
								{ name: 'Tyrannosauridae', children: [] },
								{ name: 'Ornithomimosauria', children: [] },
								{ name: 'Maniraptora', children: [
									{ name: 'Therizinosauria', children: [] },
									{ name: 'Oviraptorosauria', children: [] },
									{ name: 'Archaeopterygidae', children: [] },
									{ name: 'Dromaeosauridae', children: [] },
									{ name: 'Troodontidae', children: [] },
									{ name: 'Avialae', children: [] },
								] },
							] },
						] },
						
					] },
					{ name: 'Ornithischia', children: [
						{ name: 'Heterodontosauridae', children: [] },
						{ name: 'Genasauria', children: [
							{ name: 'Thyreophora', children: [
								{ name: 'Ankylosauria', children: [] },
								{ name: 'Stegosauria', children: [] },
							] },
							{ name: 'Neornithischia', children: [
								{ name: 'Cerapoda', children: [
									{ name: 'Ornithopoda', children: [] },
									{ name: 'Marginocephalia', children: [
										{ name: 'Ceratopsia', children: [] },
										{ name: 'Pachycephalosauria', children: [] },
									] },
								] },
								{ name: 'Groups I can\'t recognize anyone', children: [] },
							] },
						] },
					] },
				] },
			]
		}


		let origin = {
			x: canvas.width/2,
			y: canvas.height/2,
		}

		let polar_coord = { mag: Infinity, angle: 0 }
		let cart_coord = { x: 0, y: 0 }

		let mouse_clicking = false

		let root_node = cladogram
		let path = []

		let next_root_node = null

		let start_animation_radius = {
			going: false,
			time: 0,
			start: undefined,
			duration: 500,
			back: false
		}

		function hash_name(string) {
			return Math.abs(string.split('').reduce((acc, char) => acc ^ ((acc<<5)-acc) + char.charCodeAt(0), 0)) % 36 * 10
		}

		function polar_to_cart(mag, angle) {
			return [
				Math.cos(angle) * mag + origin.x,
				Math.sin(angle) * mag + origin.y
			]
		}

		function ease(x) {
			return 1 - (1 - x) * (1 - x)
		}

		function goto_node(node, new_path) {
			next_root_node = node
			path = new_path
			start_animation_radius.going = true
			start_animation_radius.time = 0
			start_animation_radius.back = true
		}

		function node_hash(node) {
			if (node.hash) return node.hash
			node.hash = hash_name(node.name)
			return node.hash
		}

		function generate_colors(root, odd = false) {
			const hash = Math.floor(hash_name(root.name)/4)
			root.hash = odd ? hash : hash + 180

			for (let i = 0; i < root.children.length; ++i) {
				generate_colors(root.children[i], i % 2 != 0)
			}
		}

		function draw_section(arc_start, arc_size, iradius, oradius) {
			const start_angle = arc_start
			const end_angle = arc_start + arc_size
			ctx.beginPath()
			ctx.arc(origin.x, origin.y, iradius, end_angle - (Math.PI/2), start_angle - (Math.PI/2), true)
			ctx.arc(origin.x, origin.y, oradius, start_angle - (Math.PI/2), end_angle - (Math.PI/2))
			ctx.fill()
		}

		function draw_node_children(root, iradius, arc_size, arc_start, depth, parents, options) {
			const {init_depth, size, anim_radius} = options

			if (depth == 0) return
			if (iradius > anim_radius) return
			if (root.children.length == 0) return


			const count = root.children.length
			const ARC = arc_size/count
			const opacity = depth/init_depth

			let texts = []

			for (let index = 0; index < count; ++index) {
				const node = root.children[index]
				
				const arc_s = index*ARC+arc_start
				const hover =
					!start_animation_radius.going &&
					polar_coord.mag > iradius && 
					polar_coord.mag < iradius + size &&
					polar_coord.angle > arc_s &&
					polar_coord.angle < arc_s + ARC

				if (hover && mouse_clicking) {
					mouse_clicking = false
					goto_node(node, [...path, ...parents])
				}
				
				const oradius = Math.max(iradius + 5, Math.min(iradius + size + (hover ? 2 : 0), anim_radius))
				
				ctx.fillStyle = `hsla(${node_hash(node)}, 50%, 60%, ${(hover ? 1 : opacity)*100}%)`

				draw_section(arc_s, ARC, iradius + 5 - (hover ? 2 : 0), oradius)

				draw_node_children(node, iradius+size, ARC, arc_s, depth - 1, [...parents, node], options)
				
				if (hover || depth == 1 || node.children.length == 0) {
					const coord = polar_to_cart(oradius+10, arc_s+ARC/2 - Math.PI/2)
					texts.push({
						coord: coord,
						align: coord[0] < origin.x ? 'end' : 'start',
						name: node.name
					})
				}
			}

			ctx.font = `${8+24*opacity}px Arial`
			ctx.fillStyle = `rgb(224, 224, 224)`

			for (const {coord, name, align} of texts) {
				ctx.textAlign = align
				ctx.fillText(name, ...coord)
			}
		}

		function show_idle(timestamp) {
			const root = root_node

			ctx.clearRect(0, 0, canvas.width, canvas.height)

			if (start_animation_radius.going) {
				if (start_animation_radius.start == undefined)
					start_animation_radius.start = timestamp

				start_animation_radius.time = timestamp - start_animation_radius.start

				if (start_animation_radius.time >= start_animation_radius.duration) {
					start_animation_radius.going = false
					start_animation_radius.time = start_animation_radius.duration
					start_animation_radius.start = undefined
				}
			}

			const anim_radius = start_animation_radius.back 
				? (1 - ease(start_animation_radius.time/start_animation_radius.duration)) * 250
				: ease(start_animation_radius.time/start_animation_radius.duration) * 250

			ctx.font = `24px Arial`
			ctx.textAlign = 'start'
			let path_y = 0
			for (const node of path) {
				const hover =
					cart_coord.y > 10 + path_y*24 &&
					cart_coord.y < 34 + path_y*24 &&
					cart_coord.x < 20 + ctx.measureText(node.name).width

				if (hover && mouse_clicking) {
					goto_node(node, path.slice(0, path_y))
				}

				ctx.fillStyle = `hsl(${node_hash(node)}, 50%, 60%)`
				ctx.fillText(node.name, hover ? 30 : 20, 20 + path_y*24)
				path_y += 1
			}

			ctx.fillStyle = `hsl(${node_hash(root)}, 50%, 60%)`
			ctx.beginPath()
			ctx.arc(origin.x, origin.y, Math.min(100, anim_radius), 0, TAU)
			ctx.fill()

			const text_size = root.name.length <= 12 ? 24 : Math.floor(240/root.name.length)
			ctx.font = `${(anim_radius/200)*text_size}px Arial`
			ctx.textAlign = 'center'
			ctx.fillStyle = `#e0e0e0`
			ctx.fillText(root.name, origin.x, origin.y)

			if (100 <= anim_radius) {
				draw_node_children(root, 100, TAU, 0, 3, [root], {
					init_depth: 3,
					size: 50,
					anim_radius: anim_radius
				})
			}

			if (next_root_node && start_animation_radius.going == false) {
				root_node = next_root_node
				next_root_node = null
				start_animation_radius.going = true
				start_animation_radius.time = 0
				start_animation_radius.back = false
			}

			window.requestAnimationFrame(show_idle)
		}

		document.addEventListener('mousemove', (e) => {
			const dist = Math.hypot(e.clientX - origin.x, e.clientY - origin.y)
			const angle = Math.atan2(e.clientY - origin.y, e.clientX - origin.x)
			const norm = (angle > 0 ? angle : angle + 2 * Math.PI) - 3*Math.PI/2

			polar_coord.mag = dist
			polar_coord.angle = (norm > 0 ? norm : norm + 4*Math.PI/2)

			cart_coord.x = e.clientX
			cart_coord.y = e.clientY
		})

		document.addEventListener('mousedown', (e) => { 
			if (e.button == 0) mouse_clicking = true
			else if (e.button == 2 && path.length > 0) {
				goto_node(path[path.length - 1], path.slice(0, -1))
			}
		})
		document.addEventListener('mouseup', (e) => { 
			if (e.button == 0) mouse_clicking = false
		})

		generate_colors(root_node)

		start_animation_radius.going = true
		window.requestAnimationFrame(show_idle)
	</script>
</body>
</html>